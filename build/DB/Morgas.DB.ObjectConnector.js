(function(t,e,n){var r,s=n("DBConn"),i=n("Organizer"),a=n("shortcut")({eq:"equals",find:"find"});r=s.ObjectConnector=t.Class(s,{db:(new i).group("objectType","objectType"),init:function(t){this.superInit(s),t||(this.db=(new i).group("objectType","objectType"))},save:function(t,e){e=[].concat(e);var n=s.sortObjs(e);for(var r in n.fresh)for(var e=n.fresh[r],i=this._getNextID(r),o=0;e.length>o;o++){var u=i.length>o?i[o]:i[i.length-1]+o-i.length+1;e[o].setID(u),this.db.add([{objectType:e[o].objectType,fields:e[o].toJSON()}])}for(var r in n.preserved)for(var e=n.preserved[r],l=this.db.getGroupValue("objectType",r),o=0;e.length>o;o++){var h=a.find(l,{fields:{ID:e[o].getID()}});h.length>0&&(h[0].value.fields=e[o].toJSON())}for(var r in n.friend){for(var e=n.friend[r],l=this.db.getGroupValue("objectType",r),c=[],o=0;e.length>o;o++){var f={fields:e[o].toJSON()},h=a.find(l,f);0===h.length&&(f.objectType=e[o].objectType,c.push(f))}this.db.add(c)}t.complete()},load:function(t,e,n,r,s){var o=this.db.getGroupValue("objectType",e.prototype.objectType),u=[];r&&(r=i.pathSort("fields."+r+".value",s));for(var l=0;o.length>l;l++)if(a.eq(o[l].fields,n)){var h=new e;h.fromJSON(o[l].fields),r?u.splice(i.getOrderIndex(h,u,r),0,h):u.push(h)}t.complete(u)},"delete":function(t,e,n){n={objectType:e.prototype.objectType,fields:s.getDeletePattern(e,n)};for(var r=JSON.stringify(n),i=this.db.filter(r,n).getFilter(r),a=0;i.length>a;a++)this.db.remove(i[a]);this.db.removeFilter(r),t.complete()},destroy:function(){this.db!==r.prototype.db&&this.db.clear(),this.db=null,this.save=this.load=this["delete"]=t.constantFunctions.ndef},_getNextID:function(t){for(var e=[],n=this.db.getGroupValue("objectType",t),r=0;n.length>0;r++){var s=a.find(n,{fields:{ID:r}});0===s.length?e.push(r):n.splice(s[0].index,1)}return e.push(r),e}}),e("ObjectConnector",r)})(Morgas,Morgas.setModule,Morgas.getModule);