(function(t,e,n){var r=n("Organizer"),s=n("shortcut")({it:"iterate",debug:"debug",det:"Detache"}),i=r.LazyCache=t.Class(r,{init:function(t,e){this.superInit(r),s.det.detacheAll(this,["get","getUnique"]),this.dbClass=t,this.connector=e;var n=new t;for(var i in n.fields)n.fields[i].options.UNIQUE&&(this.map(i,"fields."+i+".value"),this.maps[i].signals={})},add:function(t,e){var n=[],i=[];return s.it(t,function(t){var r=t.getID();t instanceof this.dbClass&&null!=r&&(this.hasMapKey("ID",r)?(e&&(this.values[this.maps.ID.values[r]]=t),n.push(this.values[this.maps.ID.values[r]])):(i.push(t),n.push(t)))},!1,!1,this),r.prototype.add.call(this,i),n},get:function(t,e,n,r){var s=JSON.stringify(e);if(r||null==this.filters[s]){n&&(n="fields."+n+".value"),this.filter(s,i.filterPattern(e),n);var o=this.filters[s].signals=[t];this._load(e,o,!1,r)}else 0==this.filters[s].signals.length?t.complete(this.getFilter(s)):this.filters[s].signals.push(t)},getUnique:function(t,e,n,r){if(null!=this.maps[e])if(r||null==this.maps[e].values[n]){var s={};if(s[e]=n,null==this.maps[e].signals[n]){var i=this.maps[e].signals[n]=[t];this._load(s,i,!0,r)}else this.maps[e].signals[n].push(t)}else t.complete(this.getMapValue(e,n));else t.error("Field "+e+" is not unique")},_load:function(t,e,n,r){s.debug(["LazyCache._load:",arguments],3);var i=this;this.connector.load(this.dbClass,t).then(function(t){i.add([].concat(t),r),t=n?t[0]:t;for(var s;s=e.shift();)s.complete(t)},function(t){s.debug(t,1);for(var r;r=e.shift();)r.complete(n?void 0:[])})}});i.filterPattern=function(t){var e={fields:{}};for(var n in t)e.fields[n]={value:t[n]};return r.filterPattern(e)}})(Morgas,Morgas.setModule,Morgas.getModule);