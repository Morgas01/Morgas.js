//Morgas.js
(function(e){Morgas={version:"0.3"},µ=Morgas,µ.revert=function(){return µ=e},µ.constantFunctions={ndef:function(){return void 0},nul:function(){return null},f:function(){return!1},t:function(){return!0},zero:function(){return 0},"boolean":function(e){return!!e}},function(){var e={};µ.setModule=function(t,n){return e[t]&&µ.debug("module "+t+" is overwritten",2),e[t]=n},µ.hasModule=function(t){return!!e[t]},µ.getModule=function(t){return e[t]||µ.debug("module "+t+" is not defined\n use µ.hasModule to check for existence",0),e[t]}}();var t=µ.setModule,n=µ.getModule,o=µ.hasModule;µ.debug=function(e,t){t||(t=0),µ.debug.verbose!==!1&&µ.debug.verbose>=t&&("function"==typeof e&&(e=e()),µ.debug.out(e,t))},t("debug",µ.debug),µ.debug.LEVEL={OFF:!1,ERROR:0,WARNING:1,INFO:2,DEBUG:3},µ.debug.verbose=µ.debug.LEVEL.WARNING,µ.getDebug=function(e){µ.debug.verbose=e},µ.setDebug=function(e){µ.debug.verbose=e},µ.debug.out=function(e,t){switch(t){case 0:console.error(e);break;case 1:console.warn(e);break;case 2:console.info(e);break;case 3:default:console.log(e)}},µ.shortcut=function(e,t,u,r){t||(t={});for(var i in e)(function(e,i){var s=void 0;Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:function(){return(null==s||r)&&("function"==typeof e?s=e(u):u&&o("goPath")?s=n("goPath")(u,e):o(e)?s=n(e):n("debug")("shortcut: could not evaluate "+e)),s}})})(e[i],i);return t},t("shortcut",µ.shortcut);var u=µ.Class=function(e,t){var u=function(){this.init.apply(this,arguments),o("Listeners")&&this instanceof n("Listeners")&&this.setState(".created")};"function"!=typeof e&&(t=e,e=r),e&&(u.prototype=Object.create(e.prototype),u.prototype.constructor=u);for(var i in t)u.prototype[i]=t[i];return u};t("Class",u);var r=µ.BaseClass=u({init:function(){},superInit:function(e){e.prototype.init.apply(this,[].slice.call(arguments,1))},superInitApply:function(e,t){this.superInit.apply(this,[e].concat([].slice.call(t)))}});t("Base",r)})(this.µ);
//DB/Morgas.DB.js
(function(t,e,n){var r,s,i,a,o=n("shortcut")({debug:"debug",det:"Detached"}),u=t.DB=t.DB||{};r=u.Connector=t.Class({init:function(){o.det.detacheAll(this,["save","load","delete","destroy"])},save:function(){throw Error("abstract Class DB.Connector")},load:function(){throw Error("abstract Class DB.Connector")},"delete":function(){throw Error("abstract Class DB.Connector")},destroy:function(){throw Error("abstract Class DB.Connector")},saveChildren:function(t,e){return this.save(t.getChildren(e))},saveFriendships:function(t,e){var n=t.relations[e],s=t.friends[e];if(!s)return o.debug("no friends in relation "+e+" found",2),new o.det.complete(!1);var i=s[0].relations[n.targetRelationName],a=t.getID();if(null==a)return o.debug("friend id is null",2),new o.det.complete(!1);for(var u=[],h=0;s.length>h;h++){var c=s[h].getID();null!=c&&u.push(c)}if(0===u.length)return o.debug("no friend with friend id found"),new o.det.complete(!1);var f=r.getFriendTableName(t.objectType,e,s[0].objectType,n.targetRelationName),d=t.objectType+"_ID",p=s[0].objectType+"_ID",g=[];n.relatedClass===i.relatedClass&&(p+=2);for(var h=0;u.length>h;h++)g.push(new l(f,d,a,p,u[h]));return this.save(g)},loadParent:function(t,e){var n=t.relations[e],r=n.relatedClass,s=n.fieldName;return this.load(r,{ID:t.getValueOf(s)}).then(function(n){var r=n[0];r.addChild(e,t),this.complete(r)})},loadChildren:function(t,e,n){var r=t.relations[e],s=rel.relatedClass,i=r.fieldName;return n[i]=this.getID(),this.load(s,n).then(function(e){t.addChildren(e),this.complete(e)})},loadFriends:function(t,e,n){var s=this,i=t.relations[e],a=i.relatedClass,u=(new a).relations[i.targetRelationName],h=t.objectType+"_ID",c=a.prototype.objectType+"_ID",f=r.getFriendTableName(t.objectType,e,a.prototype.objectType,i.targetRelationName),d={};i.relatedClass===u.relatedClass&&(c+=2),d[h]=t.getID();var p=l.Generator(f,h,c),g=this.load(p,d);return i.relatedClass===u.relatedClass&&(g=g.then(function(t){var e=this;d[c]=d[h],delete d[h],s.load(p,d).then(function(n){for(var r=0;n.length>r;r++){var s=n[r].fields[h].value;n[r].fields[h].value=n[r].fields[c].value,n[r].fields[c].value=s}e.complete(t.concat(n))},o.debug)},o.debug)),g.then(function(t){return n.ID=t.map(function(t){return t.fields[c].value}),s.load(a,n)},o.debug)},deleteFriendships:function(t,e){var n=t.relations[e],s=t.friends[e];if(!s)return o.debug("no friends in relation "+e+" found",2),new o.det.complete(!1);var i=s[0].relations[n.targetRelationName],a=t.getID();if(null==a)return o.debug("friend id is null",2),new o.det.complete(!1);for(var u=[],h=0;s.length>h;h++){var c=s[h].getID();null!=c&&u.push(c)}if(0===u.length)return o.debug("no friend with friend id found"),new o.det.complete(!1);var f=r.getFriendTableName(t.objectType,e,s[0].objectType,n.targetRelationName),d=t.objectType+"_ID",p=s[0].objectType+"_ID",g=[];if(n.relatedClass===i.relatedClass){p+=2;var v={};v[d]=u,v[p]=a,g.push(v)}var v={};v[d]=a,v[p]=u,g.push(v);for(var y=[],m=l.Generator(f,d,p),h=0;g.length>h;h++)y.push(this["delete"](m,g[h]));return new o.det(y)}}),r.sortObjs=function(t){for(var e={friend:{},fresh:{},preserved:{}},n=0;t.length>n;n++){var r=t[n],s=r instanceof l?"friend":void 0===r.getID()?"fresh":"preserved",i=r.objectType;void 0===e[s][i]&&(e[s][i]=[]),e[s][i].push(r)}return e},r.getDeletePattern=function(t,e){var n=typeof e;if(("number"===n||e instanceof u.Object)&&(e=[e]),Array.isArray(e)){for(var r=0;e.length>r;r++)e[r]instanceof t&&(e[r]=e[r].getID());e={ID:e}}return e},r.getFriendTableName=function(t,e,n,r){return[t,e,n,r].sort().join("_")},e("DBConn",r),s=u.Object=t.Class({objectType:null,init:function(t){if(t=t||{},null==this.objectType)throw"DB.Object: objectType not defined";this.fields={},this.relations={},this.parents={},this.children={},this.friends={},this.addField("ID",a.TYPES.INT,t.ID,{UNIQUE:!0,AUTOGENERATE:!0})},addRelation:function(t,e,n,r,s){this.relations[t]=new i(e,n,r||t,s)},addField:function(t,e,n,r){this.fields[t]=new a(e,n,r)},getValueOf:function(t){return this.fields[t].getValue()},setValueOf:function(t,e){"ID"!=t&&this.fields[t].setValue(e)},setID:function(t){this.fields.ID.setValue(t);for(var e in this.children)for(var n=this.children[e],r=0;n.length>r;r++)n[r]._setParent(this.relations[e],this)},getID:function(){return this.getValueOf("ID")},getParent:function(t){return this.parents[t]},_setParent:function(t,e){var n=this.relations[t.targetRelationName];this.parents[t.targetRelationName]=e,this.setValueOf(n.fieldName,e.getValueOf(t.fieldName))},_add:function(t,e,n){var r=t[e]=t[e]||[];-1==r.indexOf(n)&&r.push(n)},_get:function(t,e){return(t[e]||[]).slice(0)},addChild:function(t,e){this.relations[t].type==i.TYPES.CHILD&&(this._add(this.children,t,e),e._setParent(this.relations[t],this))},addChildren:function(t,e){for(var n=0;e.length>n;n++)this.addChild(t,e[n])},getChildren:function(t){return this._get(this.children,t)},addFriend:function(t,e){this.relations[t].type==i.TYPES.FRIEND&&(this._add(this.friends,t,e),e._add(e.friends,this.relations[t].targetRelationName,this))},addFriends:function(t,e){for(var n=0;e.length>n;n++)this.addFriend(t,e[n])},getFriends:function(t){return this._get(this.friends,t)},toJSON:function(){var t={};for(var e in this.fields)t[e]=this.fields[e].toJSON();return t},fromJSON:function(t){for(var e in this.fields)void 0!==t[e]&&this.fields[e].fromJSON(t[e]);return this},toString:function(){return JSON.stringify(this)}}),e("DBObj",s);var l=u.Firendship=t.Class({init:function(t,e,n,r,s){this.objectType=t,this.fields={},this.fields[e]=new a(a.TYPES.INT,n),this.fields[r]=new a(a.TYPES.INT,s)},toJSON:s.prototype.toJSON,fromJSON:s.prototype.fromJSON});l.Generator=function(e,n,r){return t.Class(l,{objectType:e,init:function(){this.superInit(l,e,n,null,r,null)}})},e("DBFriend",l),i=u.Relation=t.Class({init:function(t,e,n,r){if(null==r){if(e==i.TYPES.PARENT)throw"DB.Relation: "+e+" relation needs a fieldName";r="ID"}this.type=e,this.relatedClass=t,this.fieldName=r,this.targetRelationName=n}}),i.TYPES={PARENT:-1,FRIEND:0,CHILD:1},e("DBRel",i),a=u.Field=t.Class({init:function(t,e,n){this.type=t,this.value=e,this.options=n||{}},setValue:function(t){this.value=t},getValue:function(){return this.value},toJSON:function(){switch(this.type){case a.TYPES.DATE:var t=this.getValue();if(t instanceof Date)return t.getUTCFullYear()+","+t.getUTCMonth()+","+t.getUTCDate()+","+t.getUTCHours()+","+t.getUTCMinutes()+","+t.getUTCSeconds()+","+t.getUTCMilliseconds();break;default:return this.getValue()}},fromJSON:function(t){switch(this.type){case a.TYPES.DATE:this.value=new Date(Date.UTC.apply(Date,t.split(",")));break;default:this.value=t}},toString:function(){return JSON.stringify(this)},fromString:function(t){switch(this.type){case a.TYPES.BOOL:this.value=!!~~t;break;case a.TYPES.INT:this.value=~~t;break;case a.TYPES.DOUBLE:this.value=1*t;break;case a.TYPES.DATE:this.fromJSON(JSON.parse(t));break;case a.TYPES.STRING:case a.TYPES.JSON:default:this.value=JSON.parse(t)}}}),a.TYPES={BOOL:0,INT:1,DOUBLE:2,STRING:3,DATE:4,JSON:5,BLOB:6},e("DBField",a)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas.Organizer.js
(function(t,e,n){var r=n("shortcut")({it:"iterate",eq:"equals",path:"goPath"}),s=t.Organizer=t.Class({init:function(t){this.values=[],this.filters={},this.maps={},this.groups={},t&&this.add(t)},add:function(t,e,n){return e&&n&&(this.group(e),this.groups[e].values[n]=[]),r.it(t,function(t){var r=this.values.length;this.values.push(t);for(var s in this.maps)this._map(this.maps[s],r);for(var i in this.filters)this._filter(this.filters[i],r);for(var a in this.groups)this._group(this.groups[a],r);e&&n&&this.groups[e].values[n].push(r)},!1,!1,this),this},remove:function(t){var e=this.values.indexOf(t);if(-1!==e){for(var n in this.filters){var r=this.filters[n].values.indexOf(e);-1!==r&&this.filters[n].values.splice(r,1)}for(var n in this.maps)for(var s=this.maps[n].values,i=Object.keys(s),n=0;i.length>n;n++)if(s[i[n]]===t){delete s[i[n]];break}for(var n in this.groups)for(var a=this.groups[n].values,i=Object.keys(a),n=0;i.length>n;n++){var r=a[i[n]].indexOf(e);if(-1!==r){a[i[n]].splice(r,1);break}}delete this.values[e]}return this},_removeType:function(t,e){delete this[t][e]},clear:function(){for(var t in this.filters)this.filters[t].values.length=0;for(var t in this.maps)this.maps[t].values={};for(var t in this.groups)this.groups[t].values={};return this.values.length=0,this},map:function(t,e){"string"==typeof e&&(e=s._pathWrapper(e)),this.maps[t]={fn:e,values:{}};for(var n=0;this.values.length>n;n++)this._map(this.maps[t],n);return this},_map:function(t,e){var n=""+t.fn(this.values[e]);t.values[n]=e},getMap:function(t){var e={};return null!=this.maps[t]&&r.it(this.maps[t].values,function(t,n){e[n]=this.values[t]},!1,!0,this),e},hasMap:function(t){return!!this.maps[t]},hasMapKey:function(t,e){return this.maps[t]&&e in this.maps[t].values},getMapValue:function(t,e){return this.hasMapKey(t,e)?this.values[this.maps[t].values[e]]:void 0},getMapKeys:function(t){return this.hasMap(t)?Object.keys(this.maps[t].values):[]},removeMap:function(t){return this._removeType("maps",t),this},filter:function(t,e,n){switch(typeof e){case"string":e=s._pathWrapper(e);break;case"object":e=s.filterPattern(e)}"string"==typeof n&&(n=s.pathSort(n)),this.filters[t]={filterFn:e,sortFn:n,values:[]};for(var r=0;this.values.length>r;r++)this._filter(this.filters[t],r);return this},_filter:function(t,e){if(!t.filterFn||t.filterFn(this.values[e]))if(t.sortFn){var n=s.getOrderIndex(this.values[e],this.values,t.sortFn,t.values);t.values.splice(n,0,e)}else t.values.push(e)},hasFilter:function(t){return!!this.filters[t]},getFilter:function(t){var e=[];return null!=this.filters[t]&&r.it(this.filters[t].values,function(t,n){e[n]=this.values[t]},!1,!1,this),e},getFilterValue:function(t,e){return this.filters[t]&&this.filters[t].values[e]?this.values[this.filters[t].values[e]]:void 0},getFilterLength:function(t){return this.filters[t]?this.filters[t].values.length:0},removeFilter:function(t){return this._removeType("filters",t),this},group:function(t,e){if("string"==typeof e&&(e=s._pathWrapper(e)),this.groups[t]={values:{},fn:e},e)for(var n=0;this.values.length>n;n++)this._group(this.groups[t],n);return this},_group:function(t,e){if(t.fn){var n=t.fn(this.values[e]);t.values[n]=t.values[n]||[],t.values[n].push(e)}},hasGroup:function(t){return!!this.groups[t]},getGroup:function(t){var e={};if(this.hasGroup(t))for(var n in this.groups[t].values)e[n]=this.getGroupValue(t,n);return e},getGroupValue:function(t,e){var n=[];if(this.hasGroup(t)&&this.groups[t].values[e])for(var r=this.groups[t].values[e],s=0;r.length>s;s++)n.push(this.values[r[s]]);return n},hasGroupKey:function(t,e){return this.hasGroup(t)&&e in this.groups[t].values},getGroupKeys:function(t){return this.hasGroup(t)?Object.keys(this.groups[t].values):[]},removeGroup:function(t){return this._removeType("groups",t),this},destroy:function(){this.values=this.filters=this.maps=this.groups=null,this.add=this.filter=this.map=this.group=t.constantFunctions.ndef}});s._pathWrapper=function(t){return function(e){return r.path(e,t)}},s.sort=function(t,e,n){return(n?-1:1)*(t>e)?1:e>t?-1:0},s.pathSort=function(t,e){return t=t.split(","),function(n,i){for(var a=0,o=0;t.length>o&&0===a;o++)a=s.sort(r.path(n,t[o]),r.path(i,t[o]),e);return a}},s.filterPattern=function(t){return function(e){return r.eq(e,t)}},s.getOrderIndex=function(t,e,n,r){for(var s=(r?r:e).length,i=Math.ceil(s/2),a=i,o=null;i&&a>0&&s>=a&&(1!==i||-1!==o);){o=i;var u=r?e[r[a-1]]:e[a-1];i=Math.ceil(Math.abs(i)/2)*Math.sign(n(t,u))||1,a+=i}return a=Math.min(Math.max(a-1,0),s)},s.getSortedOrder=function(t,e){var n=[];return r.it(t,function(r,i){var a=s.getOrderIndex(r,t,e,n);n.splice(a,0,i)}),n},e("Organizer",s)})(Morgas,Morgas.setModule,Morgas.getModule);
//DB/Morgas.DB.ObjectConnector.js
(function(t,e,n){var r,s=n("DBConn"),i=n("Organizer"),a=n("shortcut")({eq:"equals",find:"find"});r=s.ObjectConnector=t.Class(s,{db:(new i).group("objectType","objectType"),init:function(t){this.superInit(s),t||(this.db=(new i).group("objectType","objectType"))},save:function(t,e){e=[].concat(e);var n=s.sortObjs(e);for(var r in n.fresh)for(var e=n.fresh[r],i=this._getNextID(r),o=0;e.length>o;o++){var u=i.length>o?i[o]:i[i.length-1]+o-i.length+1;e[o].setID(u),this.db.add([{objectType:e[o].objectType,fields:e[o].toJSON()}])}for(var r in n.preserved)for(var e=n.preserved[r],l=this.db.getGroupValue("objectType",r),o=0;e.length>o;o++){var h=a.find(l,{fields:{ID:e[o].getID()}});h.length>0&&(h[0].value.fields=e[o].toJSON())}for(var r in n.friend){for(var e=n.friend[r],l=this.db.getGroupValue("objectType",r),c=[],o=0;e.length>o;o++){var f={fields:e[o].toJSON()},h=a.find(l,f);0===h.length&&(f.objectType=e[o].objectType,c.push(f))}this.db.add(c)}t.complete()},load:function(t,e,n,r,s){var o=this.db.getGroupValue("objectType",e.prototype.objectType),u=[];r&&(r=i.pathSort("fields."+r+".value",s));for(var l=0;o.length>l;l++)if(a.eq(o[l].fields,n)){var h=new e;h.fromJSON(o[l].fields),r?u.splice(i.getOrderIndex(h,u,r),0,h):u.push(h)}t.complete(u)},"delete":function(t,e,n){n={objectType:e.prototype.objectType,fields:s.getDeletePattern(e,n)};for(var r=JSON.stringify(n),i=this.db.filter(r,n).getFilter(r),a=0;i.length>a;a++)this.db.remove(i[a]);this.db.removeFilter(r),t.complete()},destroy:function(){this.db!==r.prototype.db&&this.db.clear(),this.db=null,this.save=this.load=this["delete"]=t.constantFunctions.ndef},_getNextID:function(t){for(var e=[],n=this.db.getGroupValue("objectType",t),r=0;n.length>0;r++){var s=a.find(n,{fields:{ID:r}});0===s.length?e.push(r):n.splice(s[0].index,1)}return e.push(r),e}}),e("ObjectConnector",r)})(Morgas,Morgas.setModule,Morgas.getModule);
//DB/Morgas.DB.IndexedDBConnector.js
(function(e,t,n){var r=n("DBConn"),s=n("shortcut")({det:"Detached",it:"iterate",eq:"equals",find:"find",DBObj:"DBObj",DBFriend:"DBFriend"}),i=e.Class(r,{init:function(e){this.superInit(r),this.name=e,s.det.detacheAll(this,["_open"])},save:function(t,n){n=[].concat(n);var r=i.sortObjs(n),o=Object.keys(r);this._open(o).then(function(n){var i=s.it(r,s.det.detache(function(t,r,i){var o=n.transaction(i,"readwrite");o.onerror=function(n){e.debug(n,0),t.complete(n)},o.oncomplete=function(n){e.debug(n,2),t.complete()};var a=o.objectStore(i);s.it(r,function(t){var n=t.toJSON(),r="put";void 0===n.ID&&(delete n.ID,r="add");var s=a[r](n);s.onerror=function(t){e.debug(t,0)},s.onsuccess=function(n){e.debug(n,3),t.setID&&t.setID(s.result)}})}),!1,!0);n.close(),t.complete(new s.det(i)),this.complete()},t.error)},load:function(t,n,r){this._open().then(function(i){if(i.objectStoreNames.contains(n.prototype.objectType)){var o=i.transaction(n.prototype.objectType,"readonly"),a=[];o.onerror=function(n){e.debug(n,0),i.close(),t.error(n)},o.oncomplete=function(){i.close(),t.complete(a)};var u=o.objectStore(n.prototype.objectType);if("number"==typeof r.ID||Array.isArray(r.ID))s.it([].concat(r.ID),function(t){var i=u.get(t);i.onerror=function(t){e.debug(t,0)},i.onsuccess=function(t){if(e.debug(t,3),s.eq(i.result,r)){var o=new n;o.fromJSON(i.result),a.push(o)}}});else{var l=u.openCursor();l.onerror=function(n){e.debug(n,0),i.close(),t.error(n)},l.onsuccess=function(){if(l.result){if(s.eq(l.result.value,r)){var e=new n;e.fromJSON(l.result.value),a.push(e)}l.result["continue"]()}}}}else i.close(),t.complete([]);this.complete()},t.error)},"delete":function(t,n,i){var o=this,a=n.prototype.objectType,u=null;if("number"==typeof i||i instanceof s.DBObj||i instanceof s.DBFriend||Array.isArray(i)){var l=r.getDeletePattern(n,i).ID;u=s.det.complete(l)}else u=this._open().then(function(n){var r=this,o=[],u=n.transaction(a,"readonly");u.onerror=function(s){e.debug(s,0),n.close(),t.error(s),r.error(s)},u.oncomplete=function(){n.close(),r.complete(o)};var l=u.objectStore(a),c=l.openCursor();c.onerror=function(s){e.debug(s,0),n.close(),t.error(s),r.error(s)},c.onsuccess=function(){c.result&&(s.eq(c.result.value,i)&&o.push(c.result.key),c.result["continue"]())}},t.error);u.then(function(r){return r.length>0?o._open().then(function(i){var o=i.transaction(n.prototype.objectType,"readwrite");o.onerror=function(n){e.debug(n,0),i.close(),t.error(n)};var u=o.objectStore(a),l=s.it(r,s.det.detache(function(t,n){var r=u["delete"](n);r.onerror=function(r){e.debug(r,0),t.complete(n)},r.onsuccess=function(n){e.debug(n,3),t.complete()}}));return new s.det(l).then(function(){i.close(),t.complete(Array.slice(arguments)),this.complete()},e.debug)}):(t.complete(!1),this.complete(),void 0)},function(e){db.close(),t.error(e,0),this.complete()})},destroy:function(){},_open:function(e,t){var n=this,r=indexedDB.open(this.name);r.onerror=function(t){e.error(t,0)},r.onsuccess=function(){for(var s=[],i=r.result,o=r.result.version,a=0;t&&t.length>a;a++)i.objectStoreNames.contains(t[a])||s.push(t[a]);if(0===s.length)e.complete(i);else{var u=indexedDB.open(n.name,o+1);u.onerror=function(t){e.error(t,0)},u.onupgradeneeded=function(){for(var e=0;s.length>e;e++)u.result.createObjectStore(s[e],{keyPath:"ID",autoIncrement:!0})},u.onsuccess=function(){n.version=u.result.version,e.complete(u.result)},i.close()}}}});i.sortObjs=function(e){for(var t={},n=0;e.length>n;n++){var r=e[n],s=r.objectType;void 0===t[s]&&(t[s]=[]),t[s].push(r)}return t},t("IndexedDBConnector",i),t("IDBConn",i)})(Morgas,Morgas.setModule,Morgas.getModule);
//DB/Morgas.Organizer.LazyCache.js
(function(t,e,n){var r=n("Organizer"),s=n("shortcut")({it:"iterate",debug:"debug",det:"Detache"}),i=r.LazyCache=t.Class(r,{init:function(t,e){this.superInit(r),s.det.detacheAll(this,["get","getUnique"]),this.dbClass=t,this.connector=e;var n=new t;for(var i in n.fields)n.fields[i].options.UNIQUE&&(this.map(i,"fields."+i+".value"),this.maps[i].signals={})},add:function(t,e){var n=[],i=[];return s.it(t,function(t){var r=t.getID();t instanceof this.dbClass&&null!=r&&(this.hasMapKey("ID",r)?(e&&(this.values[this.maps.ID.values[r]]=t),n.push(this.values[this.maps.ID.values[r]])):(i.push(t),n.push(t)))},!1,!1,this),r.prototype.add.call(this,i),n},get:function(t,e,n,r){var s=JSON.stringify(e);if(r||null==this.filters[s]){n&&(n="fields."+n+".value"),this.filter(s,i.filterPattern(e),n);var o=this.filters[s].signals=[t];this._load(e,o,!1,r)}else 0==this.filters[s].signals.length?t.complete(this.getFilter(s)):this.filters[s].signals.push(t)},getUnique:function(t,e,n,r){if(null!=this.maps[e])if(r||null==this.maps[e].values[n]){var s={};if(s[e]=n,null==this.maps[e].signals[n]){var i=this.maps[e].signals[n]=[t];this._load(s,i,!0,r)}else this.maps[e].signals[n].push(t)}else t.complete(this.getMapValue(e,n));else t.error("Field "+e+" is not unique")},_load:function(t,e,n,r){s.debug(["LazyCache._load:",arguments],3);var i=this;this.connector.load(this.dbClass,t).then(function(t){i.add([].concat(t),r),t=n?t[0]:t;for(var s;s=e.shift();)s.complete(t)},function(t){s.debug(t,1);for(var r;r=e.shift();)r.complete(n?void 0:[])})}});i.filterPattern=function(t){var e={fields:{}};for(var n in t)e.fields[n]={value:t[n]};return r.filterPattern(e)}})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas.Detached.js
(function(t,e,n){var s=n("shortcut")({debug:"debug"}),r=function(t,e){return function(n,r){try{var i=t.apply({complete:n,error:r},e);i&&"function"==typeof i.then?i.then(n,r):void 0!==i&&n(i)}catch(a){s.debug(a,1),r(a)}}},i=t.Detached=t.Class({init:function(t,e){var n=t===i.WAIT;n&&(t=arguments[1]),this.fn=[].concat(t||[]),this.onError=[],this.onComplete=[],this.onAlways=[],this.onPropagate=[],this.status=0,this.args=void 0,n||(0===this.fn.length?this.status=1:this._start(e))},_start:function(t){for(var e=0;this.fn.length>e;e++)"function"==typeof this.fn[e]&&(this.fn[e]=new Promise(r(this.fn[e],t)));var n=this;Promise.all(this.fn).then(function(t){n._setStatus(1,t)},function(){n._setStatus(-1,Array.slice(arguments,0))})},_setStatus:function(t,e){if(this.status=t,this.args=e,1===t)for(;this.onComplete.length>0;)this.onComplete.shift()._start(this.args);else if(-1===t){for(;this.onError.length>0;)this.onError.shift()._start(this.args);for(;this.onPropagate.length>0;)this.onPropagate.shift()._setStatus(t,this.args)}for(var n=[1===this.status].concat(this.args);this.onAlways.length>0;)this.onAlways.shift()._start(n);this.onComplete.length=this.onError.length=this.onPropagate.length=this.onAlways.length=this.fn.length=0},error:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)t[e]=new i(i.WAIT,t[e]),-1==this.status&&this.finished>=this.fn.length?t[e]._start(this.args):0===this.status&&this.onError.push(t[e]);return t[t.length-1]},complete:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)t[e]=new i(i.WAIT,t[e]),1==this.status?t[e]._start(this.args):0==this.status&&this.onComplete.push(t[e]);return t[t.length-1]},then:function(t,e){var n=this.complete(t);return e===!0?this.propagateError(n):this.error(e),n},always:function(t){t=[].concat(t);for(var e=0;t.length>e;e++)if(t[e]=new i(i.WAIT,t[e]),0!==this.status){var n=[1===this.status].concat(this.args);t[e]._start(n)}else 0===this.status&&this.onAlways.push(t[e]);return t[t.length-1]},propagateError:function(t){0===this.status?this.onPropagate.push(t):-1===this.status&&0===t.status&&t._setStatus(-1,this.args)}});i.WAIT={},e("Detached",i),i.complete=function(){var t=new i;return t.args=arguments,t},i.error=function(){var t=new i;return t.status=-1,t.args=arguments,t},i.detache=function(t,e){return e=e||window,function(){var n=Array.slice(arguments,0);return new i(function(){n.unshift(this);try{return t.apply(e,n)}catch(r){s.debug(r,1),this.error(r)}})}},i.detacheAll=function(t,e){e=[].concat(e);for(var n=0;e.length>n;n++){var s=t[e[n]];t[e[n]]=i.detache(s,t)}}})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas.util.object.equals.js
(function(e,t){var n=e.util=e.util||{},i=n.object||{};i.equals=function(e,t){if(e===t)return!0;if(void 0===e||null===e)return!1;if(t instanceof RegExp)return t.test(e);if("function"==typeof t)return"function"==typeof e?!1:t(e);if("function"==typeof e.equals)return e.equals(t);if("object"==typeof t){if("object"!=typeof e&&Array.isArray(t))return-1!==t.indexOf(e);for(var n in t)if(!i.equals(e[n],t[n]))return!1;return!0}return!1},t("equals",i.equals)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas.util.object.find.js
(function(e,t,n){var i=e.util=e.util||{},r=i.object||{},s=n("shortcut")({eq:"equals",it:"iterate"});r.find=function(e,t,n){var i=[];return s.it(e,function(e,r){s.eq(e,t)&&i.push(n?e:{value:e,index:r})}),i},t("find",r.find)})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas.util.object.iterate.js
(function(µ,SMOD,GMOD){

	var util=µ.util=µ.util||{};
	var obj=util.object||{};
	
	/** createIterator
	 * Creates an iterator for {any} in {backward} order.
	 * {isObject} declares {any} as a Map or Array. 
	 */
	//TODO iterator & Set & Map
	obj.createIterator=function* (any,backward,isObject)
	{
		if(any.length>=0&&!isObject)
		{
			for(var i=(backward?any.length-1:0);i>=0&&i<any.length;i+=(backward?-1:1))
			{
				yield [any[i],i];
			}
		}
		else if (typeof any.next==="function"||typeof any.entries==="function")
		{
			if(typeof any.entries==="function")
			{
				any=any.entries();
			}
			var step=null;
			while(step=any.next(),!step.done)
			{
				yield step.value.reverse();
			}
		}
		else
		{
			var k=Object.keys(any);
			if(backward)
			{
				k.revert();
			}
			for(var i=0;i<k.length;i++)
			{
				yield [any[k[i]],k[i]];
			}
		}
		
	};
	/** iterate
	 * Iterates over {any} calling {func} with {scope} in {backward} order.
	 * {isObject} declares {any} as an Object with a length property.
	 * 
	 * returns Array of {func} results
	 */
	//TODO iterator & Set & Map
	obj.iterate=function(any,func,backward,isObject,scope)
	{
		var rtn=[];
		if(!scope)
		{
			scope=window;
		}
		if(any.length>=0&&!isObject)
		{
			for(var i=(backward?any.length-1:0);i>=0&&i<any.length;i+=(backward?-1:1))
			{
				rtn.push(func.call(scope,any[i],i,i,false));
			}
		}
		else if (typeof any.next==="function"||typeof any.entries==="function")
		{
			if(typeof any.entries==="function")
			{
				any=any.entries();
			}
			var step=null,index=0;
			while(step=any.next(),!step.done)
			{
                isObject=step.value[1]!==step.value[0]&&step.value[0]!==index;
				rtn.push(func.call(scope,step.value[1],step.value[0],index,isObject));
                index++;
			}
		}
		else
		{
			var k=Object.keys(any);
			if(backward)
			{
				k.revert();
			}
			for(var i=0;i<k.length;i++)
			{
				rtn.push(func.call(scope,any[k[i]],k[i],i,true));
			}
		}
		return rtn;
	};
	SMOD("Iterator",obj.createIterator);
	SMOD("iterate",obj.iterate);
	
})(Morgas,Morgas.setModule,Morgas.getModule);
//Morgas.util.object.goPath.js
(function(e,t){var n=e.util=e.util||{},i=n.object||{};i.goPath=function(e,t){var n=t;for("string"==typeof n&&(n=n.split("."));n.length>0&&e;)e=e[n.shift()];return n.length>0?void 0:e},t("goPath",i.goPath)})(Morgas,Morgas.setModule,Morgas.getModule);